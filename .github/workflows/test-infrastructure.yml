name: Test Infrastructure Deployment

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "infrastructure/**"
      - ".github/workflows/test-infrastructure.yml"

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  test-infrastructure:
    name: Test Infrastructure Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/package.json

      - name: Install dependencies
        working-directory: ./infrastructure
        run: npm ci

      - name: Build TypeScript
        working-directory: ./infrastructure
        run: npm run build

      - name: Run CDK synth (without AWS credentials)
        working-directory: ./infrastructure
        run: |
          # Test CDK synthesis without deploying
          npx cdk synth --no-lookups

      - name: Validate CDK template
        working-directory: ./infrastructure
        run: |
          # Check if the synthesized template is valid JSON
          if [ -f "cdk.out/NoahInfrastructureStack.template.json" ]; then
            echo "âœ… CDK template generated successfully"
            # Validate JSON syntax
            cat cdk.out/NoahInfrastructureStack.template.json | jq . > /dev/null
            echo "âœ… CDK template is valid JSON"
          else
            echo "âŒ CDK template not found"
            exit 1
          fi

      - name: Check for common issues
        working-directory: ./infrastructure
        run: |
          echo "ğŸ” Checking for common CDK issues..."

          # Check if template has resources
          RESOURCE_COUNT=$(cat cdk.out/NoahInfrastructureStack.template.json | jq '.Resources | length')
          echo "Resources in template: $RESOURCE_COUNT"

          if [ "$RESOURCE_COUNT" -lt 5 ]; then
            echo "âš ï¸ Template has very few resources ($RESOURCE_COUNT)"
          else
            echo "âœ… Template has $RESOURCE_COUNT resources"
          fi

          # Check for required resources
          if cat cdk.out/NoahInfrastructureStack.template.json | jq -e '.Resources | to_entries[] | select(.value.Type == "AWS::ECS::Cluster")' > /dev/null; then
            echo "âœ… ECS Cluster found"
          else
            echo "âŒ ECS Cluster not found"
          fi

          if cat cdk.out/NoahInfrastructureStack.template.json | jq -e '.Resources | to_entries[] | select(.value.Type == "AWS::ECS::Service")' > /dev/null; then
            echo "âœ… ECS Service found"
          else
            echo "âŒ ECS Service not found"
          fi

          if cat cdk.out/NoahInfrastructureStack.template.json | jq -e '.Resources | to_entries[] | select(.value.Type == "AWS::RDS::DBInstance")' > /dev/null; then
            echo "âœ… RDS Database found"
          else
            echo "âŒ RDS Database not found"
          fi

      - name: Summary
        run: |
          echo ""
          echo "ğŸ‰ Infrastructure validation completed!"
          echo "The CDK template builds successfully and contains expected resources."
